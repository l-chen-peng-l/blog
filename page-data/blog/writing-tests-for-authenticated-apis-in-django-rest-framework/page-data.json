{"componentChunkName":"component---src-templates-article-page-js","path":"/blog/writing-tests-for-authenticated-apis-in-django-rest-framework/","webpackCompilationHash":"0aef3b7d25e0eca4e3b9","result":{"data":{"markdownRemark":{"id":"d55785f2-d467-536e-ab54-eec3a34d9d7f","html":"<p>If you are new to <a href=\"http://www.django-rest-framework.org/\">Django Rest Framework</a> and <a href=\"http://dot.evonove.it/\">Django Oauth Toolkit</a> and are having trouble writing automated tests for your <code>is_authenticated</code> APIs, you have come to the write place. The problem arises because for a token to be generated we need to first create an application and then retrieve it's <code>client_id</code> and <code>client_secret</code> before sending it along with username and password for generating <code>access_token</code>.</p>\n<p>Before beginning though we're gonna work on the following assumptions:</p>\n<ul>\n<li>There's a model called Books.</li>\n<li>There's a <code>generic.ListAPIView</code>, with URL name <code>books:list</code> </li>\n<li>The permission on the URL is <code>is_authenticated</code> </li>\n</ul>\n<p>Now that, that's out of the way, we can begin the fun part.</p>\n<p>In your <code>tests.py</code> file we create a class called BookListTest:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>test <span class=\"token keyword\">import</span> APITestCase\n\n\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BookListTest</span><span class=\"token punctuation\">(</span>APITestCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">pass</span></code></pre></div>\n<p>To begin testing, we need a few things setup first, to do so we use the <code>setUp</code> method. Here we will, first create a <code>test user</code>, set up a dummy <code>application</code>, then create <code>two dummy book entries</code>, and finally define our <code>fetch url</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BookListTest</span><span class=\"token punctuation\">(</span>APITestCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Create a Test User.</span>\n        self<span class=\"token punctuation\">.</span>test_user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create_user<span class=\"token punctuation\">(</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'testuser'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test@example.com'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'testpassword'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># Set Up a Test Application</span>\n        self<span class=\"token punctuation\">.</span>application <span class=\"token operator\">=</span> Application<span class=\"token punctuation\">(</span>\n            name <span class=\"token operator\">=</span> <span class=\"token string\">\"Test Application\"</span><span class=\"token punctuation\">,</span>\n            redirect_uris <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost\"</span><span class=\"token punctuation\">,</span>\n            user <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>test_user<span class=\"token punctuation\">,</span>\n            client_type <span class=\"token operator\">=</span> Application<span class=\"token punctuation\">.</span>CLIENT_CONFIDENTIAL<span class=\"token punctuation\">,</span>\n            authorization_grant_type <span class=\"token operator\">=</span> Application<span class=\"token punctuation\">.</span>GRANT_AUTHORIZATION_CODE<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># Create Entries in our model to fetch the list of.</span>\n        self<span class=\"token punctuation\">.</span>foo_book <span class=\"token operator\">=</span> Book<span class=\"token punctuation\">(</span>\n            title <span class=\"token operator\">=</span> <span class=\"token string\">\"foo\"</span>\n            author <span class=\"token operator\">=</span> <span class=\"token string\">\"bar author\"</span>\n        <span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>foo_book<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bar_book <span class=\"token operator\">=</span> Book<span class=\"token punctuation\">(</span>\n            title <span class=\"token operator\">=</span> <span class=\"token string\">\"bar\"</span>\n            author <span class=\"token operator\">=</span> <span class=\"token string\">\"foo author\"</span>\n        <span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bar_book<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># URL to fetch the list of the books.</span>\n        self<span class=\"token punctuation\">.</span>fetch_url <span class=\"token operator\">=</span> reverse<span class=\"token punctuation\">(</span><span class=\"token string\">\"books:list\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Everything we write in the above function are created at the beginning of every Test. Now let's come to writing the actual test. To do that we'll need an <code>access_token</code>, and will have to set the <code>authorization header</code> with the <code>bearer token</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BookListTest</span><span class=\"token punctuation\">(</span>APITestView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">test_list_books</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        Ensure we can list all the books.\n        \"\"\"</span>\n        <span class=\"token comment\"># Create A Token</span>\n        tok <span class=\"token operator\">=</span> AccessToken<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>\n            user <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>test_user<span class=\"token punctuation\">,</span>\n            token <span class=\"token operator\">=</span> <span class=\"token string\">'1234567890'</span><span class=\"token punctuation\">,</span>\n            application <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">,</span>\n            scope <span class=\"token operator\">=</span> <span class=\"token string\">'read write'</span><span class=\"token punctuation\">,</span>\n            expires <span class=\"token operator\">=</span> timezone<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> datetime<span class=\"token punctuation\">.</span>timedelta<span class=\"token punctuation\">(</span>days<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># Set Authorization Header</span>\n        auth_headers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'HTTP_AUTHORIZATION'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Bearer '</span> <span class=\"token operator\">+</span> tok<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n        response <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>fetch_url<span class=\"token punctuation\">,</span> <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">'json'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>auth_headers<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># Make assertions</span>\n        self<span class=\"token punctuation\">.</span>assertEqual<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">.</span>HTTP_200_OK<span class=\"token punctuation\">)</span></code></pre></div>\n<p>And that's it, just run the test. But before you do that, make sure you have required <code>imports</code>. You will need the following imports:</p>\n<ul>\n<li><code>User</code>, <code>Book</code> Models</li>\n<li>from <code>django.urls</code>, <code>reverse</code></li>\n<li>from <code>django.utils</code>, <code>timezone</code></li>\n<li>from <code>oauth2_provider.models</code>, <code>Application</code> and <code>AccessToken</code> models</li>\n<li>from <code>rest_framework</code>, <code>status</code></li>\n<li><code>datetime</code></li>\n<li>from <code>rest_framework.test</code>, <code>APITestCase</code></li>\n</ul>\n<p>Happy Testing.</p>","fields":{"slug":"/blog/writing-tests-for-authenticated-apis-in-django-rest-framework/"},"frontmatter":{"date":"April 13, 2018","title":"Writing Tests for Authenticated APIs in Django REST Framework","cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIEAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAFs1iLzhh//xAAbEAADAAIDAAAAAAAAAAAAAAABAgMABBASFP/aAAgBAQABBQIBmXzAMbUTJU7rXZc8f//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/Aaf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAbEAEAAQUBAAAAAAAAAAAAAAABEQACAxAhYf/aAAgBAQAGPwJGAaLi7vtQuPUHNf/EABsQAQACAgMAAAAAAAAAAAAAAAEAESExQWHB/9oACAEBAAE/Ia4spVthcOOBiI+TFVqqiLj9bm8z/9oADAMBAAIAAwAAABAfH//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8Qp4Rn/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAB/9oACAECAQE/EAnL/8QAHBABAQACAgMAAAAAAAAAAAAAAREAMSFRQXGB/9oACAEBAAE/EKcIQEPQQMJo+lqTWnJGk0DwPSZo5tW+HXWJBPhVV9yNpqvK5//Z","aspectRatio":1.5,"src":"/static/999df285dd12af814deee7226b04ac27/1511b/authenticated_api_testing.jpg","srcSet":"/static/999df285dd12af814deee7226b04ac27/79e64/authenticated_api_testing.jpg 269w,\n/static/999df285dd12af814deee7226b04ac27/b1729/authenticated_api_testing.jpg 538w,\n/static/999df285dd12af814deee7226b04ac27/1511b/authenticated_api_testing.jpg 1075w,\n/static/999df285dd12af814deee7226b04ac27/57d19/authenticated_api_testing.jpg 1613w,\n/static/999df285dd12af814deee7226b04ac27/ede7d/authenticated_api_testing.jpg 2150w,\n/static/999df285dd12af814deee7226b04ac27/32afe/authenticated_api_testing.jpg 5184w","sizes":"(max-width: 1075px) 100vw, 1075px"}},"publicURL":"/static/authenticated_api_testing-999df285dd12af814deee7226b04ac27.jpg"},"meta_title":"Writing Tests for Authenticated Routes in Django REST Framework","meta_description":"How to write tests for Django OAuth Toolkit Authenticated APIs in Django REST Framework.","tags":["Django","DRF","API","Testing","Authentication","OAuth Toolkit"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"d55785f2-d467-536e-ab54-eec3a34d9d7f"}}}